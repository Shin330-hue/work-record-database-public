# 図面管理システム 公開版ユーザーガイド

## 1. このドキュメントの目的
このドキュメントは、公開版 Web アプリの基本的な使い方をまとめたものです。

対象:
- 閲覧ユーザー（図番検索・手順閲覧・追記閲覧）
- 管理ユーザー（ログイン・登録・編集・追記管理）
- 現場作業者（追記情報の投稿）

## 2. このアプリの考え方
- 閲覧ページは、取引先会社名や図番ごとに、図面データ・プログラムデータ・作業内容を確認するための画面です。
- 管理ページは、情報を登録・編集するための画面です。
- 追記情報は、対象図番に対して現場の最新情報（テキスト・画像・動画）を追加するための機能です。

## 3. まず最初に（起動）
1. `npm install`
2. `cp .env.example .env.local`
3. `npm run dev`
4. ブラウザで `http://localhost:3000` を開く

ポート 3000 が埋まっている場合は、表示された別ポート（例: 3003）を使用してください。

## 4. 画面一覧と役割
- `/` トップページ
  - 会社選択、図番検索、最新追記、町工場GPTへの遷移
- `/category/[companyId]`
  - 会社内カテゴリ選択
- `/drawings/[companyId]/[category]`
  - カテゴリ内の図番一覧
- `/instruction/[drawingNumber]`
  - 作業手順詳細、添付ファイル閲覧、関連図番遷移、追記投稿
- `/contributions/all`
  - 全追記の時系列表示（閲覧専用）
- `/chat`
  - 町工場GPTチャット画面
- `/admin/login`
  - 管理画面ログイン
- `/admin`
  - 管理ダッシュボード
- `/admin/drawings/new`
  - 新規図番登録
- `/admin/drawings/list`
  - 図番検索・一覧・編集遷移
- `/admin/drawings/[id]/edit`
  - 図番詳細編集（PDF/プログラム/画像/手順/関連図番/追記管理）
- `/admin/contributions`
  - 追記一覧管理（ステータス変更・削除）
- `/admin/audit-log`
  - 監査ログ閲覧

## 5. 閲覧ユーザー向けの使い方

### 5.1 トップページ `/`
主なボタン:
- `町工場GPT` : チャット画面へ移動
- 会社カード : カテゴリ選択画面へ移動
- `全ての追記を見る` : 全追記一覧へ移動

検索の使い方:
1. 検索バーに図番やキーワードを入力
2. 候補リストから選択
3. 図番詳細ページへ遷移

補足:
- 検索履歴はブラウザのローカルストレージに保存されます
- 検索履歴は `クリア` ボタンで削除できます

### 5.2 カテゴリ選択 `/category/[companyId]`
主なボタン:
- カテゴリカード : 図番一覧へ移動
- `会社一覧に戻る` : トップへ戻る

### 5.3 図番一覧 `/drawings/[companyId]/[category]`
主なボタン:
- 図番カード : 作業手順詳細へ移動
- `カテゴリ一覧に戻る` : 1つ前へ戻る

### 5.4 作業手順詳細 `/instruction/[drawingNumber]`
主な操作:
- 作業手順・概要・改訂履歴の閲覧
- 添付PDF/画像/動画/プログラムの参照
- 関連図番カードから別図番へ遷移
- `検索に戻る` でトップへ戻る
- 追記情報の確認・投稿

### 5.5 全追記一覧 `/contributions/all`
主な操作:
- 追記を時系列で確認
- 図番リンクから詳細画面へ移動
- 画像クリックで拡大表示
- `トップページに戻る`

## 6. 現場作業者向け（追記情報）
- 追記情報は対象図番ごとに最新情報を残すための機能です。
- 形式: テキスト、画像、動画
- 使いどころ:
  - 加工時の注意点
  - 現場で有効だった改善案
  - 不具合時の状況メモ

## 7. 町工場GPT（LocalLLM機能）

### 7.1 機能概要
- 蓄積データを参照しながら問い合わせるための機能です。
- 自社向け NotebookLM 風の利用を想定した試験的機能です。

### 7.2 公開版の前提
- 初期状態では利用できません（LocalLLM環境が未準備のため）。
- 利用にはローカル環境で Ollama の準備が必要です。

### 7.3 利用手順（正常系）
1. Ollama をインストールして起動
2. モデルを取得

```bash
ollama pull qwen2.5:7b-instruct-q4_k_m
```

3. `.env.local` に設定を追加

```bash
OLLAMA_BASE_URL=http://localhost:11434
ENABLE_RAG=true
```

4. `npm run dev` を再起動
5. `/chat` を開き、モデルを選んで質問する

## 8. 管理ユーザー向けの使い方

### 8.1 ログイン `/admin/login`
操作:
1. パスワード入力
2. `ログイン`

公開版サンプル:
- パスワード: `demo-admin-2026`

### 8.2 ダッシュボード `/admin`
主な役割:
- 件数サマリー確認（図番・企業・未処理追記）
- 管理メニューへの入口

主な導線:
- `新規図番登録`
- `図番一覧・編集`
- `追記管理ページへ`
- `監査ログを見る`

### 8.3 新規図番登録 `/admin/drawings/new`
入力項目:
- 図面PDF（複数可）
- プログラムファイル（複数可）
- 会社名（既存選択 or 新規作成）
- 図番
- 製品カテゴリ
- 製品名
- 作業手順タイトル
- 機械種別（複数選択可）

主なボタン:
- `+ 新規会社を作成`
- `自動生成を適用`（タイトル）
- `登録`
- `キャンセル`

### 8.4 図番一覧 `/admin/drawings/list`
主な操作:
1. 図番/製品名、会社で検索
2. 結果行の `表示` で閲覧画面へ
3. 結果行の `編集` で編集画面へ

### 8.5 図番編集 `/admin/drawings/[id]/edit`
主な機能:
- 基本情報更新（説明、キーワード、注意事項など）
- 機械種別ごとのステップ編集
- PDF/プログラム/画像/動画の追加・削除
- 関連図番追加・削除
- 追記内容の確認と「追記情報から消す」操作

重要:
- 画面内の追加/削除は一部が「更新ボタンで確定」方式です
- 最後に `更新する` を押して保存します

### 8.6 追記管理 `/admin/contributions`
主な操作:
- ステータスフィルタ（all/active/merged）
- キーワード検索
- 追記のステータス変更
- 追記の削除

### 8.7 監査ログ `/admin/audit-log`
主な役割:
- 管理操作履歴の確認

## 9. 開発中の制約（現時点）
- このアプリは開発中です。
- 多言語切り替え機能は未実装です。
- 管理画面で「図番データの完全削除」は未実装です。
- 権限切り分けは今後の運用設計対象です。
- 運用時は必要に応じて、ファイル単位の手動削除やデータ修正で対応してください。

## 10. 典型的な利用シナリオ

### 10.1 閲覧のみ
1. `/` で会社を選択
2. カテゴリを選択
3. 図番を選択
4. `/instruction/...` で手順確認

### 10.2 新規登録から確認まで
1. `/admin/login` でログイン
2. `/admin/drawings/new` で図番登録
3. `/admin/drawings/list` で検索
4. `表示` で公開側画面の見え方を確認

### 10.3 追記メンテナンス
1. `/admin/contributions` を開く
2. Active を確認
3. 必要に応じてステータス変更 or 削除

## 11. 補足
この公開版はデモ用途です。実運用データは含めず、サンプルデータで利用してください。
